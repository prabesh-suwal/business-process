server:
  port: 8088

spring:
  application:
    name: memo-gateway
  
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        service-name: ${spring.application.name}
        health-check-path: /actuator/health
        health-check-interval: 15s

    # Spring Cloud Gateway Configuration
    gateway:
      server:
        webflux:
          enabled: true

          # Global CORS configuration for SSO cookies
          globalcors:
            corsConfigurations:
              '[/**]':
                allowedOrigins:
                  - "http://localhost:5173"
                  - "http://localhost:5174"
                allowedMethods:
                  - GET
                  - POST
                  - PUT
                  - DELETE
                  - OPTIONS
                allowedHeaders: "*"
                allowCredentials: true
                maxAge: 3600
          
          # Default filters applied to all routes
          default-filters:
            # Remove duplicate CORS headers (backend may also set them)
            - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_UNIQUE
           
      
      
          routes:
            # Auth Routes (Proxy to CAS)
            - id: auth-routes
              uri: http://localhost:9000
              predicates:
                - Path=/auth/**
              filters:
                - name: CookiePropagation
                
            # Memo Service Routes (Memos)
            - id: memo-service-memos
              uri: http://localhost:9008
              predicates:
                - Path=/memos/**
              filters:
                - name: JwtAuthentication
                
            # Memo Service Routes (Config)
            - id: memo-service-config
              uri: http://localhost:9008
              predicates:
                - Path=/memo-config/**
              filters:
                - name: JwtAuthentication

            # Workflow Service Routes (Tasks & Processes)
            - id: workflow-tasks
              uri: http://localhost:9002
              predicates:
                - Path=/workflow/api/tasks/**
              filters:
                - name: JwtAuthentication
                - RewritePath=/workflow(?<segment>/?.*), ${segment}

            - id: workflow-processes
              uri: http://localhost:9002
              predicates:
                - Path=/workflow/api/processes/**
              filters:
                - name: JwtAuthentication
                - RewritePath=/workflow(?<segment>/?.*), ${segment}
                
            # Form Service Routes (for fetching Memo Form Definitions)
            - id: form-service
              uri: http://localhost:9006
              predicates:
                - Path=/memo/api/forms/**
              filters:
                - name: JwtAuthentication
                - RewritePath=/memo/api/forms(?<segment>/?.*), /api/forms${segment}

  data:
    redis:
      host: localhost
      port: 6379

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway

# Gateway Security Config
gateway:
  product-code: MMS
  audience: memo-api
  jwt:
    jwks-uri: http://localhost:9000/.well-known/jwks.json
    issuer: http://localhost:9000
  rate-limit:
    enabled: true
    default-limit: 100
    window-seconds: 60

logging:
  level:
    com.enterprise.memo.gateway: DEBUG
    org.springframework.cloud.gateway: INFO
