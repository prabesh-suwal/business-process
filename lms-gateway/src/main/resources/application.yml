server:
  port: 8086

spring:
  application:
    name: lms-gateway

  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        service-name: ${spring.application.name}
        health-check-path: /actuator/health
        health-check-interval: 15s

    gateway:
      server:
        webflux:
          enabled: true
          
          # Global CORS configuration for SSO cookies
          globalcors:
            corsConfigurations:
              '[/**]':
                allowedOrigins:
                  - "http://localhost:5174"
                  - "http://localhost:5173"
                allowedMethods:
                  - GET
                  - POST
                  - PUT
                  - DELETE
                  - OPTIONS
                allowedHeaders: "*"
                allowCredentials: true
                maxAge: 3600
                
          # Route Definitions for Spring Cloud Gateway 4.x
          routes:
            # Auth - All auth routes proxy to CAS (with cookie forwarding for SSO)
            - id: auth-login
              uri: http://localhost:9000
              predicates:
                - Path=/auth/login
                - Method=POST
              filters:
                - name: CookiePropagation

            - id: auth-session
              uri: http://localhost:9000
              predicates:
                - Path=/auth/session
                - Method=GET
              filters:
                - name: CookiePropagation

            - id: auth-token-for-product
              uri: http://localhost:9000
              predicates:
                - Path=/auth/token-for-product
                - Method=POST
              filters:
                - name: CookiePropagation

            - id: auth-logout-global
              uri: http://localhost:9000
              predicates:
                - Path=/auth/logout/global
                - Method=POST
              filters:
                - name: CookiePropagation

            # LMS Loan Products
            - id: lms-loan-products
              uri: http://localhost:9005
              predicates:
                - Path=/lms/api/loan-products/**
              filters:
                - name: JwtAuthentication
                - name: ScopeEnforcement
                - RewritePath=/lms(?<segment>/?.*), $\{segment}

            # LMS Loan Applications
            - id: lms-loan-applications
              uri: http://localhost:9005
              predicates:
                - Path=/lms/api/loan-applications/**
              filters:
                - name: JwtAuthentication
                - name: ScopeEnforcement
                - RewritePath=/lms(?<segment>/?.*), $\{segment}

            # LMS Persons (proxied to person-service)
            - id: lms-persons
              uri: http://localhost:9007
              predicates:
                - Path=/lms/api/persons/**
              filters:
                - name: JwtAuthentication
                - RewritePath=/lms/api/persons(?<segment>/?.*), /api/persons$\{segment}

            # Workflow Service - Tasks API
            - id: workflow-tasks
              uri: http://localhost:9002
              predicates:
                - Path=/workflow/api/tasks/**
              filters:
                - name: JwtAuthentication
                - RewritePath=/workflow(?<segment>/?.*), $\{segment}

            # Workflow Service - Process API
            - id: workflow-processes
              uri: http://localhost:9002
              predicates:
                - Path=/workflow/api/processes/**
              filters:
                - name: JwtAuthentication
                - RewritePath=/workflow(?<segment>/?.*), ${segment}

            # Workflow Service - Process Templates API
            - id: workflow-process-templates
              uri: http://localhost:9002
              predicates:
                - Path=/workflow/api/process-templates/**
              filters:
                - name: JwtAuthentication
                - RewritePath=/workflow(?<segment>/?.*), ${segment}

            # Form Service Routes (Direct)
            - id: form-service
              uri: http://localhost:9006
              predicates:
                - Path=/lms/api/forms/**
              filters:
                - name: JwtAuthentication
                - RewritePath=/lms/api/forms(?<segment>/?.*), /api/forms${segment}


  data:
    redis:
      host: localhost
      port: 6379

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway

# Gateway configuration
gateway:
  product-codes: [LMS, MMS]
  
  jwt:
    jwks-uri: http://localhost:9000/.well-known/jwks.json
    issuer: http://localhost:9000
    
  rate-limit:
    enabled: true
    default-limit: 100
    window-seconds: 60

logging:
  level:
    com.lms.gateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
